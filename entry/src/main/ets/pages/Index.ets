import DockBar from './DockBar';
import type { DeviceInfo } from './DockBar';
import promptAction from '@ohos.promptAction';
// å¯¼å…¥Stageæ¨¡å¼æ­£ç¡®çš„ä¸Šä¸‹æ–‡ç±»å‹
import type { Context } from '@ohos.abilityAccessCtrl';
// ä¿®å¤ï¼šå¯¼å…¥BundleInfoç±»å‹ï¼ŒåŒ¹é…DockBarçš„æœç´¢ç»“æœ
import bundleManager from '@ohos.bundle.bundleManager';

// æœç´¢ç»“æœé¡¹çš„æ¥å£å®šä¹‰
interface SearchResultItem {
  name: string; // åº”ç”¨å
  bundle: string; // åŒ…å
}

@Entry
@Component
struct LauncherDesktop {
  @State onlineDevices: Array<DeviceInfo> = [
    { deviceId: 'local_device_01', deviceName: 'æµ‹è¯•', deviceType: 'Laptop' }
  ];
  @State searchKeyword: string = '';
  @State searchResults: Array<SearchResultItem> = [];
  @State isSearching: boolean = false;
  private context: Context = getContext(this) as Context;
  private dockBar: DockBar | null = null;

  build() {
    Column({ space: 15 }) {
      // æ›¿æ¢suffixä¸ºRowå¸ƒå±€
      // æœç´¢æ  + æœç´¢æŒ‰é’® ç»„åˆå¸ƒå±€
      Row({ space: 10 }) {
        TextInput({ placeholder: 'ğŸ” æœç´¢åº”ç”¨/æ–‡ä»¶/äº’è”è®¾å¤‡' })
          .flexGrow(1) // å æ»¡å‰©ä½™å®½åº¦
          .height(48)
          .backgroundColor('#f0f2f5')
          .borderRadius(24)
          .padding({ left: 20, right: 20 })
          .fontSize(16)
          .onChange((value) => {
            this.searchKeyword = value.trim();
            if (!this.searchKeyword) {
              this.searchResults = [];
            }
          })
          .onSubmit(async () => {
            await this.handleSearch();
          });

        // æœç´¢æŒ‰é’®
        Button('æœç´¢')
          .width(60)
          .height(32)
          .backgroundColor('#007dff')
          .borderRadius(16)
          .fontColor('#fff')
          .fontSize(14)
          .onClick(async () => {
            await this.handleSearch();
          });
      }
      .width('92%') // ä¿æŒåŸå®½åº¦
      .alignItems(VerticalAlign.Center);

      // è®¾å¤‡æç¤ºï¼ˆé€»è¾‘ä¸å˜ï¼‰
      if (this.onlineDevices.length > 0) {
        Text(`ğŸ“± å·²å‘ç° ${this.onlineDevices.length} å°åˆ†å¸ƒå¼è®¾å¤‡`)
          .fontSize(15)
          .fontColor('#007dff')
          .margin({ top: 10 })
          .textAlign(TextAlign.Center);
      }

      // æœç´¢ç»“æœåŒºåŸŸ
      if (this.isSearching) {
        Text('ğŸ” æ­£åœ¨æœç´¢...')
          .fontSize(16)
          .fontColor('#666')
          .margin({ top: 20 })
          .textAlign(TextAlign.Center);
      } else if (this.searchKeyword && this.searchResults.length > 0) {
        List() {
          ForEach(this.searchResults, (item: SearchResultItem) => {
            ListItem() {
              Row({ space: 10 }) {
                Text('ğŸ“±').fontSize(20)
                Column({ space: 4 }) {
                  Text(item.name).fontSize(16).fontColor('#333')
                  Text(`åŒ…åï¼š${item.bundle}`).fontSize(12).fontColor('#999')
                }.flexGrow(1)
                Button('å¯åŠ¨')
                  .width(60)
                  .height(32)
                  .borderRadius(16)
                  .fontSize(14)
                  .onClick(async () => {
                    await this.dockBar?.launchApp(item.bundle);
                  })
              }
              .padding({ left: 15, right: 15, top: 10, bottom: 10 })
              .backgroundColor('#fff')
              .borderRadius(12)
              .margin({ bottom: 8 })
            }
          })
        }
        .width('92%')
        .height('auto')
        .flexGrow(1)
        .margin({ top: 10 });
      } else if (this.searchKeyword && this.searchResults.length === 0) {
        Text(`âŒ æœªæ‰¾åˆ°â€œ${this.searchKeyword}â€ç›¸å…³åº”ç”¨`)
          .fontSize(16)
          .fontColor('#666')
          .margin({ top: 20 })
          .textAlign(TextAlign.Center);
      } else {
        Column()
          .flexGrow(1)
          .width('100%')
          .justifyContent(FlexAlign.Center) {
          Text('æ¡Œé¢åº”ç”¨åŒºåŸŸ').fontSize(18).fontColor('#666').textAlign(TextAlign.Center);
          Text('è¾“å…¥å…³é”®è¯æœç´¢å·²å®‰è£…åº”ç”¨').fontSize(14).fontColor('#999').margin({ top: 10 }).textAlign(TextAlign.Center);
        }
      }
      DockBar({
        onlineDevices: $onlineDevices,
        searchKeyword: $searchKeyword
      })
    }
    .width('100%')
    .height('100%')
    .padding({ top: 20 })
    .backgroundColor('#f5f7fa');
  }

  private async handleSearch() {
    if (!this.searchKeyword) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥æœç´¢å…³é”®è¯' });
      return;
    }
    this.isSearching = true;
    try {
      const results = await this.dockBar?.searchApp(this.searchKeyword) || [];
      // æ ¼å¼åŒ–ç»“æœ
      this.searchResults = results.map((item: bundleManager.BundleInfo) => ({
        name: item.name || '', // ä½¿ç”¨nameå±æ€§ä½œä¸ºåº”ç”¨å
        bundle: item.name // åŒ…å
      } as SearchResultItem));
      promptAction.showToast({ message: `æ‰¾åˆ°${this.searchResults.length}ä¸ªç›¸å…³åº”ç”¨` });
    } catch (error) {
      this.searchResults = [];
      promptAction.showToast({ message: 'æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•' });
      console.error(`æœç´¢é”™è¯¯ï¼š${(error as Error).message}`);
    } finally {
      this.isSearching = false;
    }
  }
}