import promptAction from '@ohos.promptAction';
import continuationManager from '@ohos.continuation.continuationManager';
import bundleManager from '@ohos.bundle.bundleManager';
import picker from '@ohos.file.picker';
import common from '@ohos.app.ability.common';
import Want from '@ohos.app.ability.Want';
//å¯¼å…¥æƒé™ç®¡ç†æ ¸å¿ƒæ¥å£
import abilityAccessCtrl from '@ohos.abilityAccessCtrl';

// ========== çº¯æ˜¾å¼ç±»å‹å®šä¹‰ ==========
interface AppItem {
  icon: string;
  name: string;
  action: () => Promise<void>;
}

export interface DeviceInfo {
  deviceId: string;
  deviceName: string;
  deviceType: string;
}

interface ContinuationResult {
  deviceId: string;
  deviceType: string;
  deviceName?: string;
  deviceState?: number;
}

// å›¾åº“/ç›¸å†Œå¸¸è§åŒ…ååˆ—è¡¨
const GALLERY_BUNDLES = [
  'com.huawei.photo',
  'com.ohos.photo',
  'com.huawei.gallery'
];

// æ˜¾å¼å£°æ˜BundleFlag
const BUNDLE_INFO_FLAG = bundleManager.BundleFlag.GET_BUNDLE_INFO_DEFAULT;
type BundleInfo = bundleManager.BundleInfo;

interface AppConfigItem {
  bundleNames: string[];
}

@Component
export default struct DockBar {
  @Link onlineDevices: Array<DeviceInfo>;
  @Link searchKeyword: string;
  // ç»Ÿä¸€ä½¿ç”¨UIAbilityContext
  private context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext;
  private continuationToken: number = 0;
  private atManager: abilityAccessCtrl.AtManager = abilityAccessCtrl.createAtManager();

  private appList: Array<AppItem> = [
    { icon: 'âš™ï¸', name: 'è®¾ç½®', action: (): Promise<void> => this.launchApp('è®¾ç½®') },
    { icon: 'ğŸ“·', name: 'å›¾åº“', action: (): Promise<void> => this.launchApp('com.huawei.photo') },
    { icon: 'ğŸ“±', name: 'è”ç³»äºº', action: (): Promise<void> => this.launchApp('è”ç³»äºº') },
    { icon: 'ğŸ“‚', name: 'æ–‡ä»¶ç®¡ç†', action: (): Promise<void> => this.openFilePicker()  }
  ];

  private async requestBundleListPermission(): Promise<boolean> {
    try {
      promptAction.showToast({ message: 'åº”ç”¨æœç´¢åŠŸèƒ½å·²å¯ç”¨' });
      return true;
    } catch (error) {
      console.error(`æƒé™ç”³è¯·å¤±è´¥ï¼š${(error as Error).message}`);
      return false;
    }
  }
  async searchApp(keyword: string): Promise<Array<BundleInfo>> {
    try {
      const lowerKeyword = keyword.toLowerCase().trim();
      if (!lowerKeyword) return [];
      
      console.info(`ç®€åŒ–æœç´¢ï¼šå…³é”®è¯"${lowerKeyword}"`);
      return [];
    } catch (err) {
      const error = err as Error;
      console.error(`åº”ç”¨æœç´¢å¤±è´¥ï¼š${error.message}`);
      return [];
    }
  }
  async launchApp(appKey: string): Promise<void> {
    try {
      const appConfig: Record<string, AppConfigItem> = {
        'è®¾ç½®': { bundleNames: ['com.ohos.settings'] },
        'å›¾åº“': { bundleNames: GALLERY_BUNDLES },
        'è”ç³»äºº': { bundleNames: ['com.ohos.contacts'] },
        'æ–‡ä»¶ç®¡ç†': { bundleNames: ['com.ohos.filemanager', 'com.huawei.filemanager'] }
      };

      let targetApp: AppConfigItem | null = null;
      let appName = '';
      if (appConfig[appKey]) {
        targetApp = appConfig[appKey];
        appName = appKey;
      } else {
        const appNames = Object.keys(appConfig);
        for (const name of appNames) {
          if (appConfig[name].bundleNames.includes(appKey)) {
            targetApp = appConfig[name];
            appName = name;
            break;
          }
        }
      }

      if (!targetApp) {
        promptAction.showToast({ message: `æœªçŸ¥åº”ç”¨ï¼š${appKey}` });
        return;
      }

      let usableBundleName = '';
      for (const bundle of targetApp.bundleNames) {
        try {
          await bundleManager.getBundleInfo(bundle, BUNDLE_INFO_FLAG);
          usableBundleName = bundle;
          break;
        } catch (err) {
          continue;
        }
      }

      if (!usableBundleName) {
        promptAction.showToast({ message: `${appName}æœªå®‰è£…` });
        return;
      }

      const want: Want = {
        bundleName: usableBundleName,
        abilityName: '',
        action: 'ohos.want.action.startAbility'
      };
      await this.context.startAbility(want);
      promptAction.showToast({ message: `å¯åŠ¨${appName}æˆåŠŸ` });
    } catch (error) {
      const err = error as Error;
      if (err.message.includes('permission')) {
        promptAction.showToast({ message: `æ— æ³•è‡ªåŠ¨å¯åŠ¨${appKey}ï¼Œè¯·æ‰‹åŠ¨æ‰“å¼€` });
      } else {
        promptAction.showToast({ message: `å¯åŠ¨${appKey}å¤±è´¥` });
      }
      console.error(`å¯åŠ¨åº”ç”¨å¤±è´¥ï¼š${appKey}ï¼Œé”™è¯¯ï¼š${err.message}`);
    }
  }
  // ========== æ–‡ä»¶é€‰æ‹©å™¨ ==========
  private async openFilePicker(): Promise<void> {
    try {
      const documentSelectOptions = new picker.DocumentSelectOptions();
      documentSelectOptions.maxSelectNumber = 10;

      const filePicker = new picker.DocumentViewPicker();
      const result = await filePicker.select(documentSelectOptions);

      if (result.length > 0) {
        promptAction.showToast({ message: `å·²é€‰æ‹© ${result.length} ä¸ªæ–‡ä»¶` });
        console.log('é€‰æ‹©çš„æ–‡ä»¶è·¯å¾„ï¼š', result);
      }
    } catch (err) {
      console.error('æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨å¤±è´¥ï¼š', (err as Error).message);
      promptAction.showToast({ message: 'è¯·æ‰‹åŠ¨æ‰“å¼€æ–‡ä»¶ç®¡ç†' });
    }
  }

  // ========== åˆ†å¸ƒå¼äº’è”é€»è¾‘ ==========
  async aboutToAppear() {
    // ç¬¬ä¸€æ­¥ï¼šå…ˆç”³è¯·åº”ç”¨åˆ—è¡¨æƒé™ï¼ˆè§£å†³æœç´¢æƒé™é—®é¢˜ï¼‰
    await this.requestBundleListPermission();

    // ç¬¬äºŒæ­¥ï¼šåŸæœ‰åˆ†å¸ƒå¼äº’è”åˆå§‹åŒ–é€»è¾‘
    try {
      this.continuationToken = await continuationManager.registerContinuation();
      console.info(`è·¨ç«¯æ¥ç»­æ³¨å†ŒæˆåŠŸï¼Œtokenï¼š${this.continuationToken}`);

      continuationManager.on(
        'deviceSelected',
        this.continuationToken,
        (deviceList) => {
          if (deviceList && deviceList.length > 0) {
            const selectedDevice = deviceList[0];
            this.onlineDevices.push({
              deviceId: selectedDevice.id,
              deviceName: selectedDevice.name || selectedDevice.type || 'æœªçŸ¥è®¾å¤‡',
              deviceType: selectedDevice.type
            });
            promptAction.showToast({
              message: `é€‰æ‹©è®¾å¤‡ï¼š${selectedDevice.type || 'æœªçŸ¥è®¾å¤‡'}`
            });
          }
        }
      );
    } catch (error) {
      console.error(`è·¨ç«¯æ¥ç»­åˆå§‹åŒ–å¤±è´¥ï¼š${(error as Error).message}`);
      promptAction.showToast({ message: 'è·¨ç«¯åŠŸèƒ½åˆå§‹åŒ–å¤±è´¥' });
    }
  }

  aboutToDisappear() {
    if (this.continuationToken > 0) {
      continuationManager.unregisterContinuation(this.continuationToken)
        .then(() => console.info('è·¨ç«¯æ¥ç»­æ³¨é”€æˆåŠŸ'))
        .catch((err: Error) => console.error(`æ³¨é”€å¤±è´¥ï¼š${err.message}`));
    }
  }

  private async crossDeviceContinue() {
    if (this.continuationToken === 0) {
      promptAction.showToast({ message: 'è·¨ç«¯æ¥ç»­æœªæ³¨å†Œ' });
      return;
    }

    try {
      await continuationManager.startContinuationDeviceManager(this.continuationToken);
      promptAction.showToast({ message: 'æ‰“å¼€åˆ†å¸ƒå¼è®¾å¤‡åˆ—è¡¨' });
    } catch (error) {
      console.error(`å¯åŠ¨è®¾å¤‡ç®¡ç†å¤±è´¥ï¼š${(error as Error).message}`);
      promptAction.showToast({ message: `å¤±è´¥ï¼š${(error as Error).message.slice(0, 20)}` });
    }
  }

  private multiScreenCollaboration() {
    this.crossDeviceContinue();
    promptAction.showToast({ message: 'å¯åŠ¨å¤šå±ååŒè®¾å¤‡é€‰æ‹©' });
  }
  // æ³¨é‡Šæ‰é‡å¤å®šä¹‰ï¼Œä½¿ç”¨åŸæœ‰çš„æ–¹æ³•å®šä¹‰
  // public searchApp = this.searchApp;
  // public launchApp = this.launchApp;

  build() {
    Column() {
      Divider()
        .width('100%')
        .height(0.5)
        .color('#e5e7eb')

      Row() {
        ForEach(this.appList, (item: AppItem) => {
          Column({ space: 4 }) {
            Text(item.icon).fontSize(24)
            Text(item.name).fontSize(12).fontColor('#333')
          }
          .onClick(() => {
            item.action()
          })
          .width(60)
          .alignItems(HorizontalAlign.Center)
        })
      }
      .justifyContent(FlexAlign.SpaceAround)
      .alignItems(VerticalAlign.Center)
      .width('100%')
      .height(80)
      .backgroundColor('#f8f9fa')
      .padding({ left: 10, right: 10 })
    }
  }
}